services:
  docs-nginx:
    image: nginx:1.29-alpine3.22
    platform: linux/arm64/v8
    environment:
      ENVIRONMENT: ${ENVIRONMENT}
    container_name: docs-nginx-${ENVIRONMENT}
    restart: unless-stopped
    ports:
      - ${LOCAL_PORT}:80
    volumes:
      - docs_html:/var/www/html
      - docs_md:/var/www/md
      - ./nginx/robots:/var/www/robots
      - ./nginx/templates:/etc/nginx/templates
      - ./nginx/redirects.conf:/etc/nginx/redirects.conf

  docs-sphinx-init:
    platform: linux/arm64/v8
    build:
      context: ./sphinx
      dockerfile: Dockerfile
      args:
        MODE: "init"
    container_name: docs-sphinx-init-${ENVIRONMENT}
    environment:
      ENVIRONMENT: ${ENVIRONMENT}
    volumes:
      - docs_html:/var/www
      - ./source:/docs/source
    restart: "no"

  docs-sphinx-builder:
    platform: linux/arm64/v8
    build:
      context: ./sphinx
      dockerfile: Dockerfile
      args:
        MODE: "builder"
    container_name: docs-sphinx-builder-${ENVIRONMENT}
    environment:
      ENVIRONMENT: ${ENVIRONMENT}
    volumes:
      - docs_html:/var/www
      - ./source:/docs/source
    restart: unless-stopped
    profiles: ["local"]
    depends_on:
      docs-sphinx-init:
        condition: service_completed_successfully

  docs-llms-txt:
    platform: linux/arm64/v8
    build:
      context: ./llms-txt
      dockerfile: Dockerfile
    container_name: docs-llms-txt-${ENVIRONMENT}
    restart: unless-stopped
    volumes:
      - docs_md:/app/output
      - ./llms-txt/config.toml:/app/config.toml
      - ./llms-txt/src:/app/src
    depends_on:
      docs-sphinx-init:
        condition: service_completed_successfully
      docs-nginx:
        condition: service_started

volumes:
  docs_html:
    name: docs_html
    driver: local
  docs_md:
    name: docs_md
    driver: local
