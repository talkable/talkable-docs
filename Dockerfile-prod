# Step 1: Build static content with Sphinx using the same approach as Dockerfile-sphinx
FROM python:3.12-alpine3.22 as builder

# Install UV
RUN pip install uv

# Set working directory
WORKDIR /docs

# Copy project files
COPY pyproject.toml uv.lock ./

# Install dependencies using UV
RUN uv sync --frozen

# Copy source files and build static content
COPY source/ ./source/
RUN uv run sphinx-build --builder dirhtml --write-all --fresh-env /docs/source /docs/_build

# Step 2: Nginx image with static content
FROM nginx:1.29-alpine3.22

# Copy nginx configuration
COPY nginx/templates/default.conf.template /etc/nginx/templates/default.conf.template
COPY nginx/redirects.conf /etc/nginx/redirects.conf

# Copy built static content from builder
COPY --from=builder /docs/_build/ /var/www/html/

# Copy robots.txt files
COPY nginx/robots/ /var/www/

# Expose port 80
EXPOSE 80

# Use the default CMD from the nginx base image